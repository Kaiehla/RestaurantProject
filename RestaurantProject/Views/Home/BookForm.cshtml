@model ReserveForm
@{
    ViewData["Title"] = "Book Form";

    Layout = "_Layout-Filled";
}

<div class="container">
    <div class="py-5 text-center">
        <h2>Reservation form</h2>
        <p class="lead">This is the reservation form</p>
    </div>

    <form class="needs-validation" id="reserveForm" name="reserveForm" method="post" asp-action="SubmitReservation" novalidate>
        <input id="packageId" value="" hidden asp-for="PackageId">
    <div class="row g-5">
        <!--RESERVATION SUMMARY-->
        <div class="col-md-5 col-lg-4 order-md-last">
            <h5 class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-primary">Your Reservation Summary</span>
            </h5>
            <ul class="list-group mb-3">
                <li class="list-group-item d-flex justify-content-between lh-sm">
                    <div>
                        <h6 class="my-0">Reservation Date</h6>
                        <input class="form-control" id="datepicker" placeholder="July 10, 2023" value="" required asp-for="ReservationDate">
                        <div class="invalid-feedback">
                            Valid date is required.
                        </div>
                    </div>
                </li>
                <li class="list-group-item d-flex justify-content-between lh-sm">
                    <div>
                        <h6 class="my-0">Reservation Time</h6>
                        <input class="form-control" id="timepicker" placeholder="10:30PM" value="" required asp-for="ReservationTime">
                        <div class="invalid-feedback">
                            Valid time is required.
                        </div>
                    </div>
                </li>
                <li class="list-group-item d-flex justify-content-between lh-sm">
                    <div>
                        <h6 class="my-0">Chosen Package</h6>

                        @* @Html.DropDownListFor(pm => pm.PackageName, Model.PackageNames, new {@class="form-select", @id="dropdown", @data_id=Model.Price}) *@
                        <select class="form-select" id="packageName" name="packageName" asp-for="PackageName">
                            @for(int i = 0; i < Model.PackageNames.Count; i++)
                            {
                                <option value=@Model.PackageNames[i] data-price="@Model.Prices[i]" data-id="@Model.PackageIds[i]">@Model.PackageNames[i]</option>
                            }
                        </select>
                        <div class="invalid-feedback">
                            Valid package is required.
                        </div>
                           @*  <input type="text" class="form-control" id="packageId" placeholder="@Model" value="@packageName" required asp-for="PackageName" /> *@
                    </div>
                </li>
                <li class="list-group-item d-flex justify-content-between lh-sm">
                    <div>
                        <h6 class="my-0">Number of Guests</h6>
                        <input type="number" class="form-control" id="numGuest" placeholder="0" value="" required asp-for="NumOfGuest" />
                        <div class="invalid-feedback">
                            Valid number of Guests is required.
                        </div>
                    </div>
                </li>
            </ul>
            <ul class="list-group mb-3">
                <li class="list-group-item d-flex justify-content-between lh-sm">
                    <div>
                        <h6 class="my-0">Price (in Philippine Pesos)</h6>
                        <input type="number" class="form-control" id="price" placeholder="0.00" value="" asp-for="Price" readonly />
                    </div>
                </li>
            </ul>
        </div>

        <!--CLIENT DETAILS-->
        <div class="col-md-7 col-lg-8">
            <h4 class="mb-3">Client details</h4>
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label for="firstName" class="form-label">First name</label>
                        <input type="text" class="form-control" id="firstName" placeholder="Juan" value="" required asp-for="FirstName">
                        <div class="invalid-feedback">
                            Valid first name is required.
                        </div>
                    </div>

                    <div class="col-sm-6">
                        <label for="lastName" class="form-label">Last name</label>
                        <input type="text" class="form-control" id="lastName" placeholder="Dimagiba" value="" required asp-for="LastName">
                        <div class="invalid-feedback">
                            Valid last name is required.
                        </div>
                    </div>


                    <div class="col-12">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" placeholder="you@example.com" required asp-for="Email">
                        <div class="invalid-feedback">
                            Please enter a valid email address for shipping updates.
                        </div>
                    </div>

                    <div class="col-12">
                        <label for="address" class="form-label">Address</label>
                        <input type="text" class="form-control" id="address" placeholder="1234 Main St" required asp-for="CityAdd">
                        <div class="invalid-feedback">
                            Please enter your city address.
                        </div>
                    </div>

                    <div class="col-12">
                        <label for="number" class="form-label">Phone Number</label>
                        <input type="text" class="form-control" id="number" placeholder="091234567891" required asp-for="PhoneNumber">
                        <div class="invalid-feedback">
                            Please enter your shipping address.
                        </div>
                    </div>
                </div>
            <br>
                <button class="w-100 btn btn-dark btn-lg mb-5" id="continueButton" type="submit" >Continue to checkout</button>
            <br/>
            <br />
            <br />
            <br />
        </div>
    </div>
    </form>
</div>

<!-- Confirmation Modal-->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Continue to checkout with provided information?</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body ps-5 pe-5">
                    <label class="form-label">Name</label>
                    <input class="form-control" id="modalName" value="" readonly/>

                    <label class="form-label mt-1">Email</label>
                    <input class="form-control" id="modalEmail" value="" readonly />

                <label class="form-label mt-1">Address</label>
                    <input class="form-control" id="modalAddress" value="" readonly />

                <label class="form-label mt-1">Phone Number</label>
                    <input class="form-control" id="modalNumber" value="" readonly />

                    <hr />

                <label class="form-label mt-1">Reservation Date</label>
                    <input class="form-control" id="modalDate" value="" readonly />

                <label class="form-label mt-1">ReservationTime</label>
                    <input class="form-control" id="modalTime" value="" readonly />

                <label class="form-label mt-1">Package</label>
                    <input class="form-control" id="modalPackageName" value="" readonly />

                <label class="form-label mt-1">Number of Guests</label>
                    <input class="form-control" id="modalNumGuest" value="" readonly />

                <label class="form-label mt-1">Price</label>
                    <input class="form-control mb-5" id="modalPrice" value="" readonly />


                <button class="w-100 btn btn-dark btn-lg mb-4" id="confirmButton" type="button">Continue</button>
                </div>
            </div>
        </div>
    </div>

<!-- Error Modal (No table with sufficient capacity found)-->
<div class="modal fade" id="noFreeTableCapacityModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Reservation Error</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">No table to accomodate @Context.Request.Query["numOfGuest"] guests</label>
            </div>

            <div class="modal-footer">
                <button class="btn btn-dark" id="exit" data-bs-dismiss="modal">Exit</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal (No free tables found / All Tables are occupied)-->
<div class="modal fade" id="noFreeTableModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Reservation Error</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">There are no free tables at the moment</label>
            </div>

            <div class="modal-footer">
                <button class="btn btn-success" id="exit" data-bs-dismiss="modal">Exit</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        var flag = false;
        //When an item is selected in the dropdown menu, get the data-price attribute (which contains the price of the package) and display the price
        $(function () {
            $('#packageName').change(function () {
                var option = $(this.options[this.selectedIndex]);
                const price = option.attr('data-price');
                const packageId = option.attr('data-id');
                $('#price').val(price);
                $('#packageId').val(packageId);
            });
        })
        //When the page has loaded, get the price of the package selected in the homepage by using the data-id attribute
        $(function () {
            $(document).ready(function () {
                var select = document.getElementById('packageName');
                var option = $(select.options[select.selectedIndex]);
                const price = option.attr('data-price');
                const packageId = option.attr('data-id');
                $('#price').val(price);
                $('#packageId').val(packageId);

                //Show modal if there are no available tables due to Seating Capacity requirements
                if ('@TempData["NoTablesAvailableError"]') {
                    $('#noFreeTableCapacityModal').modal('show');
                }
                else if ('@TempData["NoFreeTables"]') {
                    $('#noFreeTableModal').modal('show');
                }
            });
        //When "Continue To Checkout" button is pressed, empty input fields will get warning messages
        //When all information has been entered, a confirmation dialog wil pop up
        })
        $(function () {
            'use strict'

            var forms = document.querySelectorAll('.needs-validation')
            Array.prototype.slice.call(forms)
                .forEach(function (form) {
                    form.addEventListener('submit', function (event) {
                        if (!form.checkValidity()) {
                            event.preventDefault()
                            event.stopPropagation()
                        }
                        else{
                            if (flag == false){
                                //Copy input fields and transfer them to the modal
                                var firstName = $('#firstName').val()
                                var lastName = $('#lastName').val()
                                $('#modalName').val(firstName + ' ' + lastName)
                                $('#modalEmail').val($('#email').val())
                                $('#modalAddress').val($('#address').val())
                                $('#modalNumber').val($('#number').val())
                                $('#modalDate').val($('#datepicker').val())
                                $('#modalTime').val($('#timepicker').val())
                                $('#modalPackageName').val($('#packageName').val())
                                $('#modalNumGuest').val($('#numGuest').val())
                                $('#modalPrice').val($('#price').val())

                                $('#confirmModal').modal('show');
                                event.preventDefault()
                                event.stopPropagation()
                            }
                            else{
                                return true
                            }
                        }

                        form.classList.add('was-validated')
                    }, false)
                })
        })
        //When the "Continue" button is pressed, the reservation will finally be submitted
        $(function () {
            $('#confirmButton').click(function () {
                flag = true;
                $('#reserveForm').trigger('submit');
            });
        })
    </script>
}

